#### -*- mode:sh -*- vim:ft=sh
####
## No More than a C build system for clang, gcc and msvc.
## https://github.com/junjiemars/nore
####
## feature
####


if [ "dumb" != "$nm_feature_run" ]; then
  echo $echo_n_opt "checking for $nm_feature ... $echo_c_cap"
fi


cat << END >> $NM_AUTO_ERR

----------------------------------------
checking for $nm_feature

END


if [ -n "$nm_feature_name" ]; then
    nm_have_feature=`echo $nm_feature_name \
        | tr '[\-: =]' '_' | tr '[:lower:]' '[:upper:]'`
fi


autotest_c="$NM_AUTOTEST.c"
if [ -n "CXX" ]; then
    autotest_c="$NM_AUTOTEST.cc"
fi

cat << END > $autotest_c
$nm_feature_h

int main(void) {
    $nm_feature_test;
    return 0;
}

END


nm_test="$CC $nm_feature_flags ${bin_out}${NM_AUTOTEST} $autotest_c"

`$nm_test >> "$NM_AUTO_ERR" 2>&1`

nm_found=no

if [ -x $NM_AUTOTEST ]; then

  case "$nm_feature_run" in
    yes)
      if `$NM_AUTOTEST >> "$NM_AUTO_ERR" 2>&1`; then
        nm_found=yes
        echo "$nm_found"

        if [ -n "$nm_feature_name" ]; then
          have=$nm_have_feature . ${NORE_ROOT}/auto/have
        fi

      else
        echo "$nm_found"
      fi
            ;;

    value)
      if `$NM_AUTOTEST >> "$NM_AUTO_ERR" 2>&1`; then
        nm_found=yes
        echo "$nm_found"

        cat << END >> $NM_AUTO_H

#ifndef $nm_have_feature
#define $nm_have_feature  `$NM_AUTOTEST`
#endif

END
      else
        echo "$nm_found"
      fi
            ;;
    dumb)
      nm_feature_value=`$NM_AUTOTEST 2>> "$NM_AUTO_ERR"`
      if [ 0 -eq $? ]; then
          nm_found=yes
      fi
      ;;

    bug)
      if `$NM_AUTOTEST >> "$NM_AUTO_ERR" 2>&1`; then
        echo "$nm_found"

      else
        nm_found=yes
        echo "$nm_found"

        if [ -n "$nm_feature_name" ]; then
          have=$nm_have_feature . ${NORE_ROOT}/auto/have
        fi
      fi
      ;;

    *)
      nm_found=yes
      echo "$nm_found"

      if [ -n "$nm_feature_name" ]; then
        have=$nm_have_feature . ${NORE_ROOT}/auto/have
      fi
      ;;
  esac

else
  if [ "dumb" != "$nm_feature_run" ]; then
    echo "$nm_found"
  fi

  echo "----------"    >> $NM_AUTO_ERR
  cat  $autotest_c     >> $NM_AUTO_ERR
  echo "----------"    >> $NM_AUTO_ERR
  echo $nm_test        >> $NM_AUTO_ERR
  echo "----------"    >> $NM_AUTO_ERR
fi


[ -f $NM_AUTOTEST ] && rm $NM_AUTOTEST
[ -f $autotest_c ]  && rm $autotest_c
[ -f autotest.obj ] && rm autotest.obj
