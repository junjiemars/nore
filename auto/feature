#### -*- mode:sh -*- vim:ft=sh
####
## No More than a C build system for clang, gcc and msvc.
## https://github.com/junjiemars/nore
####
## feature
####


echo_feature() {
	if [ -z "$feature_dumb" ]; then
		echo "$@"
	fi
}

echo_feature $echo_n_opt "checking for $nm_feature ... $echo_c_cap"


cat << END >> $NM_AUTO_ERR

----------------------------------------
checking for $nm_feature

END


if [ -n "$nm_feature_name" ]; then
	nm_have_feature=`echo $nm_feature_name | tr '[\-: =]' '_' | tr '[:lower:]' '[:upper:]'`
fi


autotest_c="$NM_AUTOTEST.c"
if [ -n "$feature_cxx" ]; then
	autotest_c="$NM_AUTOTEST.cc"
fi

cat << END > $autotest_c
$nm_feature_h

int main(void) {
    $nm_feature_test;
    return 0;
}

END


nm_test="$CC $nm_feature_flags \
 					$nm_feature_inc \
 					${bin_out}${NM_AUTOTEST} $autotest_c \
 					$nm_feature_ldlibs"

`$nm_test >> $NM_AUTO_ERR 2>&1`

nm_found=no

if [ -x $NM_AUTOTEST ]; then

  case "$nm_feature_run" in

    yes)

      if `$NM_AUTOTEST >> $NM_AUTO_ERR 2>&1`; then
        echo_feature "found"
        nm_found=yes

        if [ -n "$nm_feature_name" ]; then
          have=$nm_have_feature . ${NORE_ROOT}/auto/have
        fi

      else
        echo_feature "not found"
      fi
    ;;

    value)

      if `$NM_AUTOTEST >> $NM_AUTO_ERR 2>&1`; then
        echo_feature "found"
        nm_found=yes

        cat << END >> $NM_AUTO_H

#ifndef $nm_have_feature
#define $nm_have_feature  `$NM_AUTOTEST`
#endif

END
      else
        echo_feature "not found"
      fi
    ;;

    bug)

      if `$NM_AUTOTEST >> $NM_AUTO_ERR 2>&1`; then
        echo_feature "not found"

      else
        echo_feature "found"
        nm_found=yes

        if [ -n "$nm_feature_name" ]; then
          have=$nm_have_feature . ${NORE_ROOT}/auto/have
        fi
      fi
    ;;

    *)
      echo_feature "found"
      nm_found=yes

      if [ -n "$nm_feature_name" ]; then
        have=$nm_have_feature . ${NORE_ROOT}/auto/have
      fi
    ;;

  esac

else
  echo_feature "not found"

  echo "----------"    >> $NM_AUTO_ERR
  cat  $autotest_c     >> $NM_AUTO_ERR
  echo "----------"    >> $NM_AUTO_ERR
  echo $nm_test        >> $NM_AUTO_ERR
  echo "----------"    >> $NM_AUTO_ERR
fi

rm -rf $NM_AUTOTEST*
[ -f "autotest.obj" ] && rm "autotest.obj"
